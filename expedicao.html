<expedicao.html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel Expedi√ß√£o - GPS Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { 
            font-family: 'Chakra Petch', sans-serif; 
            background-color: #000000; 
            color: #e2e8f0; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
        }
        
        @media (max-width: 768px) {
            body { 
                overflow-y: auto; 
                height: auto; 
                min-height: 100vh;
            }
            main { height: auto !important; min-height: 0; }
        }

        .fade-enter-active { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        #progress-bar { transition: width linear; }
        
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #111827; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; border: 2px solid #111827; }
        
        .neon-text-yellow { text-shadow: 0 0 10px rgba(234, 179, 8, 0.5); }
        .neon-text-indigo { text-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        /* Neon Verde para o Carimbo */
        .neon-stamp-green { text-shadow: 0 0 20px rgba(34, 197, 94, 0.8), 0 0 40px rgba(34, 197, 94, 0.4); box-shadow: 0 0 30px rgba(34, 197, 94, 0.5), inset 0 0 30px rgba(34, 197, 94, 0.5); }
    </style>
</head>
<body class="flex flex-col p-2 md:p-3 pb-2 mobile-scroll">

    <header class="relative flex flex-col md:flex-row justify-between items-center mb-2 shrink-0 border-b border-gray-800 pb-2 gap-2 md:gap-0 transition-all duration-500 md:h-[10vh] md:min-h-[80px]">
        <div class="w-full md:w-1/3 flex flex-row md:flex-col justify-between md:justify-center items-center md:items-start order-2 md:order-1">
            <p id="clock" class="text-3xl md:text-6xl font-mono text-white font-bold tracking-tighter leading-none">00:00</p>
            <div class="flex items-center gap-3 mt-1 pl-1">
                <div class="flex items-center gap-1.5 bg-gray-900/80 px-2 py-0.5 rounded">
                    <span class="relative flex h-2 w-2 md:h-3 md:w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 md:h-3 md:w-3 bg-blue-500"></span></span>
                    <p class="text-blue-500 text-[10px] md:text-xs font-bold tracking-widest">EXPEDI√á√ÉO</p>
                </div>
                <span id="header-date" class="text-xs md:text-lg text-gray-400 font-bold border-l-2 border-gray-700 pl-3">--/--</span>
            </div>
        </div>

        <div class="w-full md:w-1/3 flex flex-col justify-center items-center order-1 md:order-2 mb-1 md:mb-0">
            <div class="flex items-center gap-2 md:gap-3">
                <div id="header-icon" class="p-1.5 md:p-2 rounded-xl bg-gray-900 shadow-lg transition-colors duration-500">
                    <i data-lucide="package-check" class="w-5 h-5 md:w-7 md:h-7"></i>
                </div>
                <h1 id="page-title" class="text-lg md:text-3xl font-bold text-white tracking-wide leading-none drop-shadow-md transition-colors duration-500 text-center">CARREGAMENTO</h1>
            </div>
            <span id="page-count" class="text-[10px] md:text-xs text-gray-500 font-bold tracking-widest uppercase bg-gray-900 px-3 py-0.5 rounded mt-1">...</span>
        </div>

        <div class="w-full md:w-1/3 flex justify-end items-center order-3">
            <div id="weather-box-general" class="hidden md:flex flex-col items-end bg-gray-900/40 px-3 py-1.5 rounded-xl border border-gray-700/50 shadow-lg backdrop-blur-sm">
                <span class="text-[9px] md:text-[10px] uppercase tracking-[0.2em] font-bold text-gray-500 mb-0.5">BASE ARICANDUVA</span>
                <div class="flex items-center gap-3">
                    <i id="weather-icon-gen" data-lucide="cloud" class="w-6 h-6 md:w-10 md:h-10 text-blue-400"></i>
                    <span id="weather-temp-gen" class="text-3xl md:text-5xl font-bold font-mono text-white leading-none">--¬∞</span>
                    <div class="h-6 w-px bg-gray-700"></div>
                    <div class="flex flex-col leading-none" id="weather-minmax-container">
                        <span id="weather-max-gen" class="text-xs md:text-base text-orange-400 font-mono font-bold">Max --¬∞</span>
                        <span id="weather-min-gen" class="text-xs md:text-base text-blue-300 font-mono font-bold">Min --¬∞</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full relative min-h-0 md:h-[88vh]"> 
        <div id="content-grid" class="grid grid-cols-1 md:grid-cols-2 md:grid-rows-2 gap-3 md:gap-4 w-full h-auto md:h-full pb-20 md:pb-2"></div>
        
        <div id="loading" class="absolute inset-0 flex items-center justify-center bg-black/95 z-50">
            <div class="text-center">
                <div class="w-12 h-12 md:w-24 md:h-24 border-t-4 border-b-4 border-blue-500 rounded-full animate-spin mx-auto mb-4 md:mb-6"></div>
                <p class="text-lg md:text-3xl text-blue-400 animate-pulse font-bold tracking-widest">BUSCANDO CARGAS</p>
                <p id="debug-status" class="text-gray-500 mt-2 text-xs md:text-sm font-mono">Conectando...</p>
                <button onclick="loadMockData()" class="mt-6 px-4 py-2 bg-gray-800 text-[10px] md:text-xs text-gray-400 rounded hover:bg-gray-700 transition">Modo Demo</button>
            </div>
        </div>
    </main>

    <button onclick="manualPrev()" class="fixed top-1/2 left-0 -translate-y-1/2 z-50 p-2 md:p-3 rounded-r-xl transition-all duration-300 transform active:scale-95 text-white/70 bg-black/50 md:bg-transparent md:text-white/10 md:hover:text-white md:hover:bg-gray-800/90 backdrop-blur-sm md:backdrop-blur-none border border-white/10 md:border-transparent"><i data-lucide="chevron-left" class="w-6 h-6 md:w-10 md:h-10"></i></button>
    <button onclick="manualNext()" class="fixed top-1/2 right-0 -translate-y-1/2 z-50 p-2 md:p-3 rounded-l-xl transition-all duration-300 transform active:scale-95 text-white/70 bg-black/50 md:bg-transparent md:text-white/10 md:hover:text-white md:hover:bg-gray-800/90 backdrop-blur-sm md:backdrop-blur-none border border-white/10 md:border-transparent"><i data-lucide="chevron-right" class="w-6 h-6 md:w-10 md:h-10"></i></button>
    <div class="fixed bottom-0 left-0 h-1 md:h-1.5 bg-gray-900 w-full z-40"><div id="progress-bar" class="h-full w-0"></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        const SLIDE_DURATION = 15; 
        const MAX_ITEMS = 4;
        const GOOGLE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSrIAzEFpEZV1t2A5FDqY5OuJSc1LX7-4I0hFMUoL3iPoRTSr-JKeyIIhvCH5ZYzYWSLR9g35OUnnC/pub?output=csv";
        
        const cityCache = {}; const weatherCache = {}; const BASE_LAT = "-23.565"; const BASE_LON = "-46.520"; 
        function updateBaseWeather() { fetchWeather(BASE_LAT, BASE_LON).then(data => { if(!data) return; document.getElementById('weather-temp-gen').innerText = Math.round(data.temp) + "¬∞"; document.getElementById('weather-max-gen').innerText = `‚¨Ü${data.max}¬∞`; document.getElementById('weather-min-gen').innerText = `‚¨á${data.min}¬∞`; document.getElementById('weather-icon-gen').setAttribute('data-lucide', getWeatherIconName(data.code)); document.getElementById('weather-box-general').classList.remove('hidden'); lucide.createIcons(); }); }
        function getWeatherIconName(code) { if (code >= 0 && code <= 3) return 'cloud-sun'; if (code >= 45 && code <= 48) return 'cloud-fog'; if (code >= 51 && code <= 67) return 'cloud-rain'; if (code >= 71 && code <= 77) return 'snowflake'; if (code >= 80 && code <= 99) return 'cloud-lightning'; return 'sun'; }
        async function fetchWeather(lat, lon) { const cacheKey = `${lat},${lon}`; const now = Date.now(); if (weatherCache[cacheKey] && (now - weatherCache[cacheKey].timestamp < 600000)) return weatherCache[cacheKey].data; try { const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=America%2FSao_Paulo&forecast_days=1`; const res = await fetch(url); const json = await res.json(); const data = { temp: Math.round(json.current.temperature_2m), code: json.current.weather_code, min: Math.round(json.daily.temperature_2m_min[0]), max: Math.round(json.daily.temperature_2m_max[0]) }; weatherCache[cacheKey] = { timestamp: now, data: data }; return data; } catch (e) { return null; } }
        function updateClock() { const now = new Date(); document.getElementById('clock').innerText = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}); }
        setInterval(updateClock, 1000); updateClock(); updateBaseWeather(); setInterval(updateBaseWeather, 600000);

        let slides = []; let currentSlideIndex = 0;

        function createCardHTML(data, themeColor) {
            const isLoaded = data.STATUS_CARGA && data.STATUS_CARGA.toUpperCase().includes("CARREGADO");

            // Borda Verde se carregado
            let borderClass = isLoaded ? 'border-green-500 shadow-[0_0_30px_rgba(34,197,94,0.3)]' : (themeColor === 'DIURNO' ? 'border-yellow-500' : 'border-indigo-500');
            const textNeonClass = themeColor === 'DIURNO' ? 'text-yellow-400 neon-text-yellow' : 'text-indigo-300 neon-text-indigo';
            
            // --- NOVO: CARIMBO GIGANTE CENTRAL ---
            const statusStamp = isLoaded 
                ? `<div class="absolute inset-0 z-30 flex items-center justify-center pointer-events-none overflow-hidden">
                        <div class="transform -rotate-12 border-4 md:border-[8px] border-green-500 text-green-500 font-black uppercase tracking-[0.2em] text-4xl md:text-8xl px-4 py-2 md:px-10 md:py-4 opacity-70 backdrop-blur-sm neon-stamp-green rounded-xl">
                            CARREGADO
                        </div>
                   </div>` 
                : '';

            let tituloLimpo = data.ROTULO.replace(/\(.*\)/, '').trim();

            let contentHTML = "";
            if (data.CARGA_LISTA && data.CARGA_LISTA.length > 5) {
                const itens = data.CARGA_LISTA.split(/\r?\n|,/); 
                contentHTML = `<ul class="w-full columns-1 md:columns-2 gap-3 md:gap-5 space-y-2 md:space-y-3">`; 
                itens.forEach(item => {
                    if(item.trim().length > 0) {
                        contentHTML += `<li class="break-inside-avoid bg-black/20 rounded px-3 py-2 text-base md:text-3xl font-semibold text-gray-200 border-l-[4px] md:border-l-[8px] ${themeColor === 'DIURNO' ? 'border-yellow-500/50' : 'border-indigo-500/50'} leading-snug shadow-sm">
                            ${item.trim()}
                        </li>`;
                    }
                });
                contentHTML += `</ul>`;
            } else {
                contentHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-600 opacity-50 py-4">
                    <i data-lucide="clipboard-x" class="w-10 h-10 md:w-32 md:h-32 mb-2 md:mb-6"></i>
                    <span class="text-sm md:text-2xl font-bold uppercase tracking-widest">Aguardando Carga</span>
                </div>`;
            }

            return `
            <div class="bg-gray-900 border-l-[6px] md:border-l-[16px] ${borderClass} rounded-r-xl md:rounded-r-2xl px-3 py-3 md:px-6 md:py-4 shadow-2xl flex flex-col h-auto md:h-full fade-enter-active relative overflow-hidden group transition-all duration-500 min-h-[250px] md:min-h-0">
                ${statusStamp}
                
                <div class="flex justify-between items-center z-10 shrink-0 mb-2 md:mb-3 border-b border-gray-800 pb-2 md:pb-3 md:h-[15%]">
                    <div class="flex items-center gap-2 md:gap-3 w-2/3">
                        <span class="text-2xl md:text-6xl font-bold text-white tracking-wider truncate drop-shadow-md">
                            ${tituloLimpo}
                        </span>
                    </div>
                    <div class="flex flex-col items-end w-1/3">
                        <span class="text-lg md:text-4xl font-bold ${textNeonClass} tracking-wide truncate">
                            ${data.EQUIPE}
                        </span>
                    </div>
                </div>
                
                <div class="flex-grow bg-slate-800/20 rounded-lg md:rounded-xl border border-gray-700/30 p-3 md:p-5 relative overflow-visible md:overflow-hidden md:h-[70%]">
                    <div class="static md:absolute inset-0 md:overflow-y-auto custom-scroll md:p-5">
                        ${contentHTML}
                    </div>
                </div>

                <div class="mt-2 md:mt-3 pt-2 border-t border-gray-800 z-10 shrink-0 md:h-[10%] flex items-center justify-between">
                     <span class="text-xs md:text-xl text-gray-400 font-bold uppercase tracking-wider truncate text-left flex items-center">
                        <i data-lucide="hard-hat" class="inline w-4 h-4 md:w-6 md:h-6 mr-1 md:mr-2 mb-1"></i> ${data.OBRA}
                     </span>
                     
                     ${isLoaded && data.QUEM ? `<span class="text-[8px] md:text-xs text-green-400/70 font-mono text-right ml-2 z-40"><i data-lucide="user-check" class="inline w-3 h-3"></i> ${data.QUEM.split('@')[0]}</span>` : ''}
                </div>
            </div>`;
        }

        function manualPrev() { if(window.slideInterval) clearInterval(window.slideInterval); prevSlide(); window.slideInterval = setInterval(nextSlide, SLIDE_DURATION * 1000); }
        function manualNext() { if(window.slideInterval) clearInterval(window.slideInterval); nextSlide(); window.slideInterval = setInterval(nextSlide, SLIDE_DURATION * 1000); }
        function prevSlide() { if (slides.length > 1) { currentSlideIndex = (currentSlideIndex === 0) ? slides.length - 1 : currentSlideIndex - 1; renderSlide(); } resetBar(); }
        function nextSlide() { if (slides.length > 0 && currentSlideIndex >= slides.length - 1) { atualizarDados(); } if (slides.length > 1) { currentSlideIndex = (currentSlideIndex + 1) % slides.length; renderSlide(); } resetBar(); }
        function resetBar() { const bar = document.getElementById('progress-bar'); bar.style.transition = 'none'; bar.style.width = '0%'; setTimeout(() => { bar.style.transition = `width ${SLIDE_DURATION}s linear`; bar.style.width = '100%'; }, 50); }

        function renderSlide() {
            if (slides.length === 0) return;
            document.getElementById('loading').style.display = 'none';
            const slide = slides[currentSlideIndex];
            const title = document.getElementById('page-title');
            document.getElementById('header-date').innerText = slide.items.length > 0 ? slide.items[0].DATA : "--/--";
            document.getElementById('page-count').innerText = `P√ÅGINA ${currentSlideIndex + 1} / ${slides.length}`;

            if (slide.type === 'DIURNO') {
                title.innerText = window.innerWidth > 768 ? "EXPEDI√á√ÉO DIURNA" : "DIURNO";
                title.className = "text-xl md:text-3xl font-bold text-yellow-500 tracking-wide drop-shadow-md leading-none text-center";
                document.getElementById('header-icon').innerHTML = '<i data-lucide="sun" class="w-5 h-5 md:w-7 md:h-7 text-yellow-400"></i>';
                document.getElementById('progress-bar').className = "h-full bg-yellow-500 shadow-[0_0_20px_rgba(234,179,8,0.6)]";
            } else {
                title.innerText = window.innerWidth > 768 ? "EXPEDI√á√ÉO NOTURNA" : "NOTURNO";
                title.className = "text-xl md:text-3xl font-bold text-indigo-400 tracking-wide drop-shadow-md leading-none text-center";
                document.getElementById('header-icon').innerHTML = '<i data-lucide="moon" class="w-5 h-5 md:w-7 md:h-7 text-indigo-400"></i>';
                document.getElementById('progress-bar').className = "h-full bg-indigo-500 shadow-[0_0_20px_rgba(99,102,241,0.6)]";
            }

            document.getElementById('content-grid').innerHTML = slide.items.map(item => createCardHTML(item, slide.type)).join('');
            lucide.createIcons();
            resetBar();
            window.scrollTo(0,0);
        }

        function processData(rows) {
            let dayItems = []; let nightItems = [];
            rows.forEach((row, index) => {
                let d = { 
                    ID: index, 
                    DATA: row[0], 
                    TURNO_RAW: row[1], 
                    EQUIPE: row[2], 
                    OBRA: row[4], 
                    PLACA_CAM: row[7],
                    ROTULO: row[19] || "‚òÄÔ∏è " + row[7], 
                    CARGA_LISTA: row[20] || "",
                    STATUS_CARGA: row[21] || "",
                    QUEM: row[22] || ""
                };
                if (!d.EQUIPE || d.EQUIPE === "EQUIPE" || d.EQUIPE === "") return; 
                const turnoCol = (d.TURNO_RAW || "").toUpperCase();
                let currentSection = turnoCol.includes("NOTURNO") || turnoCol.includes("TURNO-N") ? 'NOTURNO' : 'DIURNO';
                const item = { TYPE: currentSection, ...d };
                if (currentSection === 'DIURNO') dayItems.push(item); else nightItems.push(item);
            });
            slides = [];
            for (let i = 0; i < dayItems.length; i += MAX_ITEMS) slides.push({ type: 'DIURNO', items: dayItems.slice(i, i + MAX_ITEMS) });
            for (let i = 0; i < nightItems.length; i += MAX_ITEMS) slides.push({ type: 'NOTURNO', items: nightItems.slice(i, i + MAX_ITEMS) });
            currentSlideIndex = 0;
            if (slides.length > 0) { renderSlide(); if(window.slideInterval) clearInterval(window.slideInterval); if(slides.length > 1) { window.slideInterval = setInterval(nextSlide, SLIDE_DURATION * 1000); } } else { loadMockData(); }
        }

        function atualizarDados() {
            const uniqueID = Date.now();
            const googleUrlNoCache = GOOGLE_CSV + "&cb=" + uniqueID;
            const urls = [ "https://corsproxy.io/?" + encodeURIComponent(googleUrlNoCache), "https://api.allorigins.win/raw?url=" + encodeURIComponent(googleUrlNoCache) ];
            let attempt = 0;
            function tryFetch() {
                if (attempt >= urls.length) { loadMockData(); return; }
                document.getElementById('debug-status').innerText = `Sincronizando...`;
                fetch(urls[attempt], { cache: "no-store" })
                    .then(res => res.ok ? res.text() : Promise.reject())
                    .then(csv => { Papa.parse(csv, { header: false, skipEmptyLines: true, complete: (results) => processData(results.data) }); })
                    .catch(() => { attempt++; tryFetch(); });
            }
            tryFetch();
        }

        function loadMockData() {
            const mockCSV = [
                // Exemplo com Carimbo Gigante
                ["20/01/2026", "TURNO-D", "EQUIPE EXEMPLO", "", "OBRA TESTE", "", "", "ABC-1234", "", "", "", "", "", "", "", "", "", "", "", "‚òÄÔ∏è ABC-1234 (DIURNO)", "üì¶ Tinta: 20 LATA\nüì¶ Cones: 50 UN", "CARREGADO", "joao@gmail.com"],
                ["20/01/2026", "TURNO-N", "EQUIPE BETA", "", "MANUTEN√á√ÉO", "", "", "DEF-9999", "", "", "", "", "", "", "", "", "", "", "", "üåô DEF-9999 (NOTURNO)", "üì¶ Tinta Preta: 10 LATA", "", ""]
            ];
            processData(mockCSV);
            document.getElementById('debug-status').innerText = "MODO DEMO";
        }
        document.addEventListener("DOMContentLoaded", () => { atualizarDados(); });
    </script>
</body>
</html>
